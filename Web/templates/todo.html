{% extends "base.html" %}
{% block title %}任务跟进{% endblock %}
{% block content %}
<div class="todohead">
    <div class="row" id="bugfilter">
        <ul class="nav nav-pills">
            <li role="presentation" class="dropdown">
                <a class="dropdown-toggle textOverHiden" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">项目版本：全部 <span class="caret"></span>
                </a>
                <ul class="dropdown-menu product-dropdown-menu">
                    <li><a href="javascript:void(0)" data-value="">全部</a></li>
                    <li><a href="javascript:void(0)" data-value="890">syf1.1.1</a></li>
                    <li><a href="javascript:void(0)" data-value="893">syf2.0.0</a></li>
                </ul>
            </li>
            <li role="presentation" class="dropdown">
                <a class="dropdown-toggle textOverHiden" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">产品模块：全部 <span class="caret"></span>
                </a>
                <ul class="dropdown-menu product-dropdown-menu">
                <li><a href="javascript:void(0)" data-value="">全部</a></li>
                <li><a href="javascript:void(0)" data-value="890">病理评估</a></li>
                <li><a href="javascript:void(0)" data-value="893">时点测评</a></li>
                <li><a href="javascript:void(0)" data-value="892">预约管理</a></li>
                <li><a href="javascript:void(0)" data-value="891">综合检查</a></li>
                </ul>
            </li>
            <li role="presentation" class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">问题类型：全部 <span class="caret"></span>
                </a>
                <ul class="dropdown-menu bugType-dropdown-menu">
                    <li><a href="javascript:void(0)" data-value="">全部</a></li>
                    <li><a href="javascript:void(0)" data-value="Bug">缺陷</a></li>
                    <li><a href="javascript:void(0)" data-value="Task">任务</a></li>
                    <li><a href="javascript:void(0)" data-value="Require">需求</a></li>
                </ul>
            </li>
            
            <li role="presentation" class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">状态：全部活动 <span class="caret"></span></a>
                <ul class="dropdown-menu states-dropdown-menu">
                <li><a href="javascript:void(0)" data-value="Active">全部活动</a></li>
                <li><a href="javascript:void(0)" data-value="Open">未解决</a></li>
                <li><a href="javascript:void(0)" data-value="Fixed">已完成</a></li>
                <li><a href="javascript:void(0)" data-value="Rejected">已拒绝</a></li>
                </ul>
            </li>
            <li role="presentation" class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">计划日期：全部 <span class="caret"></span></a>
                <ul class="dropdown-menu planDate-dropdown-menu">
                <li><a href="javascript:void(0)" data-value="">全部</a></li>
                <li><a href="javascript:void(0)" data-value="Expired">已过期</a></li>
                <li><a href="javascript:void(0)" data-value="Today">今天</a></li>
                <li><a href="javascript:void(0)" data-value="TodayStart">今天开始</a></li>
                <li><a href="javascript:void(0)" data-value="TodayExit">今天结束</a></li>
                <li><a href="javascript:void(0)" data-value="Tomorrow">明天</a></li>
                <li><a href="javascript:void(0)" data-value="TomorrowStart">明天开始</a></li>
                <li><a href="javascript:void(0)" data-value="TomorrowExit">明天结束</a></li>
                <li><a href="javascript:void(0)" data-value="Week">本周</a></li>
                <li><a href="javascript:void(0)" data-value="WeekStart">本周开始</a></li>
                <li><a href="javascript:void(0)" data-value="WeekExit">本周结束</a></li>
                <li><a href="javascript:void(0)" data-value="NextWeek">下周</a></li>
                <li><a href="javascript:void(0)" data-value="NextWeekStart">下周开始</a></li>
                <li><a href="javascript:void(0)" data-value="NextWeekExit">下周结束</a></li>
                <li><a href="javascript:void(0)" data-value="Started">已开始</a></li>
                <li><a href="javascript:void(0)" data-value="NotStarted">未开始</a>
                </li><li><a href="javascript:void(0)" data-value="HavePlan">已计划</a></li>
                <li><a href="javascript:void(0)" data-value="NoPlan">未计划</a></li>
                </ul>
            </li>

        </ul>    
    
    <div class="buttool">
        <button class="btn btn-success" data-toggle="modal" data-target="#addtodo">任务添加</button>
        <button class="btn btn-primary">导出</button>
    </div>
    
    <!-- Modal -->
    <div class="modal fade" id="addtodo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">任务添加</h4>
                </div>
                <div class="modal-body">
                    <form class="form-inline">
                      <div class="form-group">
                        <label for="id">任务ID</label>
                        <input type="value" class="form-control" id="id" placeholder="ID" >
                      </div>
                      <div class="form-group">
                        <label for="worktype">项目版本</label>
                        <select class="form-control" id="version">
                           <option>syf1.1.1</option>
                           <option>syf2.0.0</option>
                          
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="worktype">类型</label>
                        <select class="form-control" id="worktype">
                           <option>需求</option>
                           <option>需求变更</option>
                           <option>BUG</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="module">模块</label>
                        
                        <select class="form-control" id="module">
                            <option>预约管理</option>
                            <option>术前检查</option>
                            <option>病情分析</option>
                            <option>时点测评</option>
                            <option>报告采集</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="title">标题</label>
                        <input type="text" class="form-control" id="title" style="width: 620px;" />
                      </div>
                      <div class="form-group">
                        <label for="description">描述</label>
                        <textarea  class="form-control" id="description" style="height: 130px;width:620px;"></textarea>
                      </div>
                      <div class="form-group">
                        <label for="developer">开发人员</label>
                        
                        <select  class="form-control" id="developer" >
                            <option>张路</option>
                            <option>陈梦梦</option>
                            <option>李小满</option>
                            <option>徐郁</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="tester">测试人员</label>
                        <select  class="form-control" id="tester"  >
                            <option value="高文琪">高文琪</option>
                            <option value="俞利芳">俞利芳</option>
                            <option value="王健">王健</option>
                            
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="status">状态</label>
                        <select class="form-control" id="status">
                            <option>未完成</option>
                            <option>已完成</option>
                            <option>延迟</option>
                            
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="createtime">创建日期</label>
                        <input type="date" id="createtime" class="form-control" />
                      </div>
                      <div class="form-group">
                        <label for="completetime">完成日期</label>
                        <input type="date" id="completetime" class="form-control" />
                      </div>
                      <div class="form-group">
                        <label for="remarks">备注</label>
                        <textarea  class="form-control" id="remarks" style="width: 620px;"></textarea>
                      </div>
                      
                      
                    </form>
                        
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="savetodo">保存</button>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<div>
    <table id="todolist" class="table table-hover">
    </table>
    <script type="text/javascript">
        $(document).ready(function () { initTable(); })
         
        
        var tododata=JSON.parse('{{todolists|tojson}}');
        console.log(tododata);
        function initTable(){

            $('#todolist').bootstrapTable({
                method:'post',
                toolbar:'#toolbar',
                data:tododata,
                dataType:'json',
                striped:false,  //是否行间隔色显示
                cache:false,//是否试用缓存，默认为true
                pagination:true, //s是否分页
                sortable:true,  //是否启用排序
                sortOrder:"ID asc", // 排序方式
                pageNumber:1, //初始化加载第一页，默认第一页
                pageSize:40 , //每页的记录行数
                // pageList:[6,20,50] ,  //可供选择的每页行数
                // url:'/webloadlist',
                queryParamsType:'', //默认为limit， 在默认情况下，传给服务器的参数为；offset，limit， 设置为''则传给服务器的参数为pageSize，pageNumber
                sidePagination:"client",// 分页方式，client为客户端分页，server为服务端分页
                strictSearch:true,
                clickToSelect:true,  //是否启动点击选中行
                search:false,
                // height:$(window).height() - 500,
                columns:[
                    
                            {   
                                title:"",
                                field:'state',
                                checkbox:true,
                                align:'center',
                                valign:'middle',

                                // width:20
                            },
                            {
                                title:'ID',
                                field:'rid',
                                align:'left',
                                valign:'middle',
                                width:40,
                                sortable:true,
                                class:'text-overflow'                           
                            },{
                                title:'WorkType',
                                field:'worktype',
                                align:'left',
                                valign:'middle',
                                class:'text-overflow',
                                switchable:true    
                            },{
                                title:'Module',
                                field:'module',
                                align:'center',
                                valign:'middle',
                                sortable:true,
                                editable: {
                                    type: 'select',
                                    title: '任务类型',
                                    mode: "inline", 
                                    source:[{value:"1",text:"需求"},{value:"2",text:"需求变更"},{value:"3",text:"BUG"}],
                                    validate: function (v) {
                                        if (!v) return '任务类型不能为空';

                                    }
                                },
                                switchable:true

                            },{
                                title:'Title',
                                field:'title',
                                align:'left',
                                valign:'middle',
                                editable: {
                                    type: 'text',
                                    title: '标题',
                                    mode: "inline",
                                    validate: function (v) {
                                        if (!v) return '标题不能为空';

                                    }
                                },
                                sortable:true

                            },{
                                title:'Description',
                                field:'description',
                                align:'left',
                                valign:'middle',
                                width:360,
                                editable: {
                                    type: 'textarea',
                                    title: '描述',
                                    mode: "inline"
                                },
                                sortable:true
                            },{
                                title:'Developer',
                                field:'developer',
                                align:'center',
                                valign:'middle',
                                editable: {
                                    type: 'checklist',
                                    title: '开发人员',
                                    mode: "inline",
                                    source:[{value:"1",text:"张路"},{value:"2",text:"李小满"},{value:"3",text:"徐郁"},{value:"4",text:"陈梦梦"}]

                                },
                                sortable:true
                            },{
                                title:'Tester',
                                field:'tester',
                                align:'center',
                                valign:'middle',
                                switchable:false,
                                editable: {
                                    type: 'checklist',
                                    title: '测试人员',
                                    mode: "popup",
                                    source:[{value:"1",text:"高文琪"},{value:"2",text:"俞利芳"},{value:"3",text:"王健"}]

                                },
                                sortable:true

                            },{
                                title:'Status',
                                field:'status',
                                align:'center',
                                valign:'middle',
                                editable: {
                                    type: 'select',
                                    title: '状态',
                                    mode: "inline",
                                    source:[{value:"1",text:"已完成"},{value:"2",text:"未完成"}]
                                },
                                sortable:true

                            },{
                                title:'备注',
                                field:'remarks',
                                align:'center',
                                valign:'middle',
                                editable: {
                                    type: 'textarea',
                                    title: '描述',
                                    mode: "inline"
                                },
                                sortable:true
                                
                            }
                        
                        ],
                showColumns:false,   // 是否显示列
                minimumCountColumns:2,
                showRefresh:false,  // 是否刷新
                showToggle:false,
                formatLoadingMessage: function () {
                    return ;
                }
                // onPostBody: function () {
                //     $('#todolist').editableTableWidget({editor: $('<textarea>')});
                // }
            });
        };

        //刷新数据
        var onchange= function(){
            var project = $('#project').html();
            $.ajax({
                //提交数据的类型 POST GET
                type:"POST",
                //提交的网址
                url:"/todo",
                async:false,
                //提交的数据
                data:({"project": project}),
                //返回数据的格式 "xml", "html", "script", "json", "jsonp", "text"
                datatype: "json",
                //ajax请求成功后的事件
                success:function(data){    
                    $('#tosolist').html($(data).find('#todolist').html());                
                    
                },
                //调用出错执行的函数
                error: function(XMLResponse){
                    //请求出错处理
                    alert("刷新失败");
                },
            });
        };
        $("#savetodo").click(function () {
            if ($("#title").val().trim() == "") {
                $("#title").focus();
                alert("请输入必填项！");
                return false;
            }
            
            postdata ={
                "id":$('#id').val(),
                "project":$('#project').html(),
                "version":$('#version').val(),
                "worktype":$('#worktype').val(),
                "module":$('#module').val(),
                "title":$('#title').val(),
                "description":$('#description').val(),
                "developer":$('#developer').val(),
                "tester":$('#tester').val(),
                "status":$('#status').val(),
                "createtime":$('#createtime').val(),
                "completetime":$('#completetime').val(),
                "remarks":$('#remarks').val()
            }
            $.ajax({
                //提交数据的类型 POST GET
                type:"POST",
                //提交的网址
                url:"/savetodo",
                //提交的数据
                data:postdata,
                //返回数据的格式 "xml", "html", "script", "json", "jsonp", "text"
                datatype: "json",
                //ajax请求成功后的事件
                    success:function(data){
                    
                    alert("保存成功！");
                    $('.modal').modal('hide');
                    // $('#tosolist').html($(data).find('#todolist').html());
                    onchange();
                    },
                    error: function(XMLResponse){
                    //请求出错处理
                    alert("保存失败");
                },
            });
        });

    </script>
</div>

{% endblock %}